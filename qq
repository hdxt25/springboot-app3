/* stage('SAST: OWASP: Dependency-Check') {
      steps { 
        sh '''
            curl -Lo dependency-check.zip https://github.com/jeremylong/DependencyCheck/releases/download/v12.1.0/dependency-check-ant-12.1.0-release.zip
            jar xf dependency-check.zip
            chmod +x ./dependency-check/bin/dependency-check.sh
            ./dependency-check/bin/dependency-check.sh --project "springboot-app3" --scan $WORKSPACE --format XML --out $WORKSPACE/dependency-check-report
        '''
        dependencyCheckPublisher pattern: '**/dependency-check-report.xml' 
      }
    } */


    stage('Update Deployment File') {
      environment {
        GIT_REPO_NAME = "springboot-app3"           
      }
      steps {    
        script {
          withCredentials([usernamePassword(credentialsId: 'github-cred', 
                                          usernameVariable: 'GIT_USER', 
                                          passwordVariable: 'GIT_PASS')]) {
                sh '''
                    # Ensure permissions
                    chown -R $(id -u):$(id -g) $WORKSPACE
                    chmod -R u+w $WORKSPACE
  
                    # Configure Git identity
                    git config user.email "hdxt25@gmail.com"
                    git config user.name "himanshu"
                    git config --global --add safe.directory $WORKSPACE

                    # Copy the deployment file to container temp directory
                    # cp spring-boot-app-manifests/deployment.yml /tmp/deployment.yml

                    # Replace the image tag inside the temp file
                    # sed -i "s/replaceImageTag/$GIT_COMMIT/g" /tmp/deployment.yml

                    # Move the edited file back to the original location
                    # mv /tmp/deployment.yml spring-boot-app-manifests/deployment.yml
                    # Update deployment manifest with Jenkins BUILD_NUMBER
                      sed -i "s/replaceImageTag/$GIT_COMMIT/g" spring-boot-app-manifests/deployment.yml

                    # Stage and commit changes
                    git add .
                    git commit -m "Update deployment image to version ${GIT_COMMIT}" || echo "No changes to commit"

                    # Push changes using username/password from Jenkins credentials
                    git push https://$GIT_USER:$GIT_PASS@github.com/$GIT_USER/$GIT_REPO_NAME.git HEAD:main
                '''
          }
        }
      }
    }
  }